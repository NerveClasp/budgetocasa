<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="boc-home">
  <template>
    <style>
      :host {
        display: block;
        --paper-button-background: var(--accent-color);
      }
      .action {
        margin-left: 10px;
        margin-right: 10px;
        margin-bottom: 70px;
        position: fixed;
        right: 25px;
        bottom: 25px;
      }
      /*.card-actions .card-content{
        display: flex;
        flex-direction: column;
      }*/
      .sitem{
        word-wrap: break-word;
        width: 100%;
      }
      #slist{
        display: block;
        width: 100%;
        padding: 0;
      }
      @media only screen and (min-width: 600px) {
        #slist{
          display: flex;
          flex-flow: row;
          flex-wrap: wrap;
          width: 99.4%;
          padding-left: 0.3%;
        }
        .sitem{
          width: 50%;
        }
      }
      paper-button{
        background-color: var(--accent-color);
        color: var(--primary-text-color);
      }
      .moneychange{
        width: 80%;
      }
      .finish{
        width: 20%;
        align-self: center;
      }
      .card-content{
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }
      /*#addit{
        position: fixed;
        bottom: 0px;
        width: 100%;
      }*/
    </style>
    <firebase-auth user="{{user}}"></firebase-auth>
    <firebase-document
      id="userdata"
      path="/users/[[user.uid]]"
      data={{userdata}}>
    </firebase-document>
    <firebase-document
      id="house"
      path="/nodes/[[userdata.node]]"
      data={{house}}>
    </firebase-document>
    <firebase-query
      id="shoplist"
      path="/nodes/[[userdata.node]]/shopinglist"
      data={{shoplist}}>
    </firebase-query>
    <template is="dom-if" if="[[!userdata.subscribed]]">
      <paper-card elevation="1" animated-shadow="true">
        <boc-subscription></boc-subscription>
      </paper-card>
    </template>
    <div class="currentcart" hidden="[[userdata.cart.empty]]">
      <paper-card elevation="1" animated-shadow="true">
        <div class="card-content">
          <div class="moneychange">
            <!-- <paper-badge for="moneyin" label="[[userdata.cart.entries]]"></paper-badge> -->
            <paper-input id="moneyin" label="Total Price for [[userdata.cart.entries]] items" value="{{userdata.cart.total}}" type="number"><div prefix>â‚´</div></paper-input>
        </div>
          <div class="finish">
            <paper-button raised on-tap="_finishShopping">Finish</paper-button>
          </div>
        </div>
      </paper-card>
    </div>

    <div id="slist">
      <template is="dom-repeat" items="[[shoplist]]" as="item">
        <template is="dom-if" if="[[!item.inCart]]">
          <boc-item class="sitem" node="[[userdata.node]]"
            item="[[item]]" slctd={{_selected}}>
          </boc-item>
        </template>
      </template>
    </div>
    <template is="dom-if" if="[[_selected]]">
      <!-- <paper-fab class="action" icon="add" on-tap="_add"></paper-fab> -->
      No need for adding items yet
    </template>
    <template is="dom-if" if="[[!_selected]]">
      <!-- <paper-fab class="action" icon="remove" on-tap="_add"></paper-fab> -->
    </template>
    <boc-add-item id="addit" source=[[userdata.node]]></boc-add-item>


  </template>
  <script>
    Polymer({
      is: 'boc-home',
      properties: {
        // hidden: { type: Boolean, value: true, observer: "_updown" },
        user: { type: Object },
        elev: { type: Number, value: 0 },
        counter: { type: Number, value: 0 },
        checkednum: { type: Number, value: 0},
        // _selected: { type: Boolean, value: false}
      },
      _finishShopping: function() {
        // -Kd44TLpLiktHSVbqdLJ
        var spent = parseInt(this.userdata.spent) || 0;
        var plus = this.$.moneyin.value || 0;
        var entries = this.userdata.cart.keys;
        for(i=0; i<entries.length; i++){
          this.$.shoplist.ref.child(entries[i]).remove();
        }
        var carthistory = this.userdata.cart;
        carthistory.uid = this.user.uid;
        carthistory.name = this.user.displayName;
        carthistory.date = Date().toString();
        console.log(Date().toString());
        // Generate a reference to a new location and add some data using push()
        var cartToHistory = this.$.userdata.ref.child("history").push(carthistory);

        // Get the unique key generated by push()
        var cartkey = cartToHistory.key;
        // this.$.userdata.ref.child("history").push(carthistory);
        this.$.house.ref.child("users/"+this.user.uid+"/history/"+cartkey).set(carthistory);
        this.$.house.ref.child("history/"+cartkey).set(carthistory);
        this.$.userdata.ref.child("spent").set(spent+plus);
        this.$.house.ref.child("users/"+this.user.uid+"/spent").set(spent+plus);
        this.$.userdata.ref.child("cart").set({entries: 0, total: 0, empty: true });
        console.log(entries);
      }
    });
  </script>
</dom-module>
